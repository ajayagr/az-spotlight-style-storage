<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azure File Explorer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>

<div class="container">
    <div class="header">
        <h1><i class="fas fa-cubes"></i> File Bucket</h1>
        <div class="view-toggle">
            <span>Files</span>
            <label class="toggle-switch">
                <input type="checkbox" id="viewToggle">
                <span class="slider"></span>
            </label>
            <span>Folders</span>
        </div>
    </div>
    
    <div class="upload-section">
        <input type="password" id="apiKey" class="auth-input" placeholder="API Key (required for uploads)" autocomplete="off">
        <input type="text" id="folderName" class="auth-input" placeholder="Folder (optional) e.g. photos">
        <button class="upload-btn" id="uploadBtn">
            <i class="fas fa-cloud-upload-alt"></i> Upload Files
        </button>
        <input type="file" id="fileInput" style="display: none;" multiple accept="image/*">
        <label class="stylesync-toggle">
            <input type="checkbox" id="styleSyncToggle" checked>
            <i class="fas fa-magic"></i> Auto StyleSync
        </label>
        <button class="view-styles-btn" id="viewStylesBtn">
            <i class="fas fa-palette"></i> View Styles
        </button>
    </div>

    <!-- StyleSync Progress Banner -->
    <div id="styleSyncBanner" class="stylesync-banner hidden">
        <i class="fas fa-magic spinner"></i>
        <span class="banner-text">StyleSync Processing</span>
        <span id="bannerStatus" class="banner-status">Starting...</span>
        <div class="pulse-dot"></div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Styles Modal -->
    <div id="stylesModal" class="styles-modal hidden">
        <div class="styles-modal-content">
            <div class="styles-modal-header">
                <h3><i class="fas fa-palette"></i> Configured Styles</h3>
                <button class="toast-close" id="closeStylesModalBtn">&times;</button>
            </div>
            <div id="stylesContent">Loading styles...</div>
        </div>
    </div>

    <!-- Upload Progress Overlay -->
    <div id="uploadOverlay" class="upload-overlay hidden">
        <div class="upload-modal">
            <i id="statusIcon" class="fas fa-spinner status-icon loading"></i>
            <h3 id="uploadTitle">Uploading Files...</h3>
            <p id="uploadStatus">Preparing upload...</p>
            <div class="progress-bar"><div id="progressFill" class="progress-fill" style="width: 0%"></div></div>
            <p id="uploadDetails" style="font-size: 12px; color: #888;"></p>
            <button id="closeModalBtn" class="btn btn-primary hidden">Done</button>
        </div>
    </div>

    <!-- File View (Flat Grid) -->
    <div class="file-grid" id="fileView">
        {% for file in files %}
        <div class="file-card" data-folder="{{ file.folder or '' }}" data-path="{{ file.path }}">
            <div class="card-content">
                <div class="thumb-container">
                    {% if file.path.lower().endswith(('.png', '.jpg', '.jpeg', '.gif', '.bmp', '.webp')) %}
                    <img src="/files/{{ file.path }}" class="thumb-img" alt="{{ file.name }}" loading="lazy">
                    {% else %}
                        {% if file.path.endswith('.pdf') %}
                        <i class="fas fa-file-pdf file-icon" style="color: #ff4040;"></i>
                        {% elif file.path.endswith('.txt') or file.path.endswith('.md') %}
                        <i class="fas fa-file-alt file-icon" style="color: #0078d4;"></i>
                        {% elif file.path.endswith('.zip') or file.path.endswith('.rar') %}
                        <i class="fas fa-file-archive file-icon" style="color: #fce100;"></i>
                        {% else %}
                        <i class="fas fa-file file-icon"></i>
                        {% endif %}
                    {% endif %}
                </div>
                <div class="card-info">
                    {% if file.folder %}
                    <div class="file-folder-badge" title="{{ file.folder }}">
                        <i class="far fa-folder"></i> {{ file.folder }}
                    </div>
                    {% endif %}
                    <div class="file-name" title="{{ file.name }}">{{ file.name }}</div>
                </div>
            </div>
            <button class="btn-delete" title="Delete File">
                <i class="far fa-trash-alt"></i>
            </button>
        </div>
        {% else %}
        <div class="empty-state">
            <i class="fas fa-box-open" style="font-size: 64px; margin-bottom: 20px; opacity: 0.5;"></i>
            <h3>No files yet</h3>
            <p>Upload a file to get started.</p>
        </div>
        {% endfor %}
    </div>

    <!-- Folder View (Grouped) -->
    <div id="folderView" class="hidden"></div>
</div>

<script src="/static/js/app.js"></script>
<script>
    // Attach event listeners for server-rendered file cards
    document.querySelectorAll('#fileView .file-card').forEach(card => {
        const path = card.dataset.path;
        card.querySelector('.card-content').addEventListener('click', () => downloadFile(path));
        card.querySelector('.btn-delete').addEventListener('click', (e) => deleteFile(path, e));
    });
    
    // Upload button click
    document.getElementById('uploadBtn').addEventListener('click', () => {
        document.getElementById('fileInput').click();
    });
    
    // View styles button
    document.getElementById('viewStylesBtn').addEventListener('click', showStylesModal);
    
    // Close styles modal button
    document.getElementById('closeStylesModalBtn').addEventListener('click', hideStylesModal);
    
    // Close modal button
    document.getElementById('closeModalBtn').addEventListener('click', closeModalAndRefresh);
</script>

</body>
</html>
